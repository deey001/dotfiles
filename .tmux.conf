# ==============================================================================
# .tmux.conf - Tmux Configuration File
# ==============================================================================
# This configuration enhances Tmux with better keybindings, valid mouse support,
# system clipboard integration (OSC 52), and a custom status bar.
# ==============================================================================

# ------------------------------------------------------------------------------
# Core Settings
# ------------------------------------------------------------------------------

# Change Prefix from Ctrl-b to Ctrl-a (Like GNU Screen)
unbind C-b
set -g prefix C-a
bind C-a send-prefix

# Enable True Color support
# Enable True Color support and OSC 52 clipboard support (Ms capability)
set -g default-terminal "screen-256color"
set -ga terminal-overrides ",xterm*:Tc"
set -ga terminal-overrides ",*256col*:Tc"
# Force Ms capability for OSC 52 clipboard to work in PuTTY/Alacritty/etc
set -as terminal-overrides ',*:Ms=\E]52;%p1%s;%p2%s\007'

# Increase scrollback history
set -g history-limit 50000

# Fix potential delay when pressing Esc (for Vim)
set -sg escape-time 10

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows automatically when one is closed
set -g renumber-windows on

# ------------------------------------------------------------------------------
# Mouse Support
# ------------------------------------------------------------------------------
# Enable mouse support for selecting panes, resizing, and scrolling
set -g mouse on

# Toggle mouse on/off with 'm' and 'M'
unbind m
bind m \
    set -g mouse on \;\
    display 'Mouse: ON'
unbind M
bind M \
    set -g mouse off \;\
    display 'Mouse: OFF'

# ------------------------------------------------------------------------------
# Clipboard Integration (OSC 52 with xclip fallback)
# ------------------------------------------------------------------------------
# IMPORTANT: OSC 52 doesn't work reliably in PuTTY.
# For PuTTY users: Use mouse selection (automatically copies to clipboard)
# or install X11 forwarding and use xclip.
set -s set-clipboard on

# Use Vi mode for copy mode
setw -g mode-keys vi

# Bind 'v' to begin selection (like Vim)
bind -T copy-mode-vi v send -X begin-selection

# Bind 'y' to copy - tries OSC 52 first, falls back to xclip if available
# For PuTTY: This won't work without X11 forwarding. Use mouse selection instead.
bind -T copy-mode-vi y send-keys -X copy-pipe-and-cancel "\
    if command -v xclip >/dev/null 2>&1; then \
        xclip -selection clipboard; \
    else \
        base64 -w0 | xargs -0 -I {} printf '\033]52;c;{}\a'; \
    fi"

# Update default binding of `Enter` to also copy
unbind -T copy-mode-vi Enter
bind -T copy-mode-vi Enter send-keys -X copy-pipe-and-cancel "\
    if command -v xclip >/dev/null 2>&1; then \
        xclip -selection clipboard; \
    else \
        base64 -w0 | xargs -0 -I {} printf '\033]52;c;{}\a'; \
    fi"

# Mouse drag copy behavior
unbind -T copy-mode-vi MouseDragEnd1Pane
bind -T copy-mode-vi MouseDragEnd1Pane send-keys -X copy-pipe-and-cancel "\
    if command -v xclip >/dev/null 2>&1; then \
        xclip -selection clipboard; \
    else \
        base64 -w0 | xargs -0 -I {} printf '\033]52;c;{}\a'; \
    fi"

# ------------------------------------------------------------------------------
# Navigation & Pane Management
# ------------------------------------------------------------------------------

# Split panes using | and -
bind \\ split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Switch panes easily with Alt-Arrow keys without Prefix
bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Resize panes with Prefix + Shift-Arrow keys
bind -r S-Up resize-pane -U 5
bind -r S-Down resize-pane -D 5
bind -r S-Left resize-pane -L 5
bind -r S-Right resize-pane -R 5

# Reload config file easily
bind r source-file ~/.tmux.conf \; display "Config Reloaded!"

# Synchronize panes (type in all panes at once)
# USAGE: Press Prefix + S to enable, Prefix + S again to disable
# Useful for running commands on multiple servers simultaneously
bind S set-window-option synchronize-panes \; display "Sync: #{?synchronize-panes,ON,OFF}"

# ------------------------------------------------------------------------------
# Status Bar Theme
# ------------------------------------------------------------------------------

# Colors
set -g status-bg colour235       # Dark gray background
set -g status-fg red             # Red foreground
set-option -g status-style dim

# Active Window Highlight
set-window-option -g window-status-current-style fg=brightred,bg=colour236,bright

# Pane Borders
set-option -g pane-border-style fg=white 
set-option -g pane-active-border-style fg=blue

# Alignment
set -g status-justify centre
set -g status-interval 60

# Left Side Status: Network Info
set -g status-left-length 150
# Uses the symlinked script in ~/.config/tmux/scripts/
set -g status-left "#(/bin/bash ~/.config/tmux/scripts/get_network_status.sh)"

# Right Side Status: Session and Time
set -g status-right-length 60
set -g status-right "#[fg=blue]#S #I:#P #[fg=yellow]:: %m/%d/%Y #[fg=green]:: %l:%M %p ::"

# ------------------------------------------------------------------------------
# Plugins (TPM)
# ------------------------------------------------------------------------------
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-resurrect' # Save sessions
set -g @plugin 'tmux-plugins/tmux-continuum' # Auto-save sessions

# Persistence settings
set -g @continuum-restore 'on'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
